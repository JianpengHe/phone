(()=>{"use strict";var e={200:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ReliableWebSocket=void 0,t.ReliableWebSocket=class{url;webSocket;constructor(e){this.url=e,this.reconnect()}reconnect(){if(!this.reConTimer&&1!==this.webSocket?.readyState)if(0!==this.webSocket?.readyState){this.reConTimer&&clearTimeout(this.reConTimer),this.reConTimer=0,this.webSocket?.close(),this.webSocket=new WebSocket(this.url);for(const[e,t]of this.eventListeners)this.webSocket.addEventListener(e,t);this.webSocket.addEventListener("error",(e=>{console.log(e),setTimeout((()=>this.reconnect()),500)})),this.webSocket.addEventListener("close",(e=>{console.log(e),setTimeout((()=>this.reconnect()),500)})),this.webSocket.addEventListener("open",(()=>this.tryToSend()))}else this.reConTimer=Number(setTimeout((()=>{this.reConTimer&&clearTimeout(this.reConTimer),this.reConTimer=0,this.webSocket?.close(),this.reconnect()}),3e3))}reConTimer=0;tryToSend(){let e;for(;1===this.webSocket?.readyState&&(e=this.readyToSendbufs.shift());)this.webSocket.send(e)}send(e){return this.readyToSendbufs.push(e),this.tryToSend(),this}readyToSendbufs=[];eventListeners=[];addEventListener(e,t){return this.webSocket?.addEventListener(e,t),this.eventListeners.push([e,t]),this}removeEventListener(e,t){this.webSocket?.removeEventListener(e,t);const n=this.eventListeners.findIndex((n=>n[0]===e&&n[1]===t));return n>=0&&this.eventListeners.splice(n,1),this}}}},t={};function n(o){var a=t[o];if(void 0!==a)return a.exports;var r=t[o]={exports:{}};return e[o](r,r.exports,n),r.exports}(()=>{const e=n(200),t={video:{cursor:"always",width:Math.min(screen.width,1920),height:Math.min(screen.height,1080)},audio:!1},o="test"+Math.random().toString(16).substr(-6),a=new URL(location.href);a.protocol=a.protocol.replace("http","ws"),a.pathname="/WebSocketVideo",a.search="?uid="+o;const r=new e.ReliableWebSocket(a),s=document.createElement("div");let i=0;setInterval((()=>{s.innerText=i+"fps",i=0}),1e3),document.body.appendChild(s);const c=document.createElement("video");c.autoplay=!0,window.onclick=async function(){window.onclick=null;try{c.srcObject=await navigator.mediaDevices.getDisplayMedia(t);const e=c.srcObject.getVideoTracks()[0];c.addEventListener("canplay",(async()=>{const t=c.videoHeight,n=c.videoWidth,o=new OffscreenCanvas(n,t),a=new OffscreenCanvas(n,t),s=a.getContext("2d",{willReadFrequently:!0}),d=o.getContext("2d",{willReadFrequently:!0});if(!d||!s)return;s.fillStyle="#000",s.fillRect(0,0,n,t);const h=new Uint8Array(t*n*3);let l=performance.now();const w=[];for(;"live"===e.readyState;){await new Promise((e=>setTimeout(e,20+l-(l=Math.floor(performance.now())))));let e=0;for(let t=0;t<w.length;t++){const[n,o]=w[t];if(n+3e3<l){w.length=t;break}e+=o}if(e>1536e3)continue;d.drawImage(c,0,0,n,t);const o=d.getImageData(0,0,n,t),u=s.getImageData(0,0,n,t);let m=!1,b=0;for(let e=0;e<o.data.length;e+=4){const t=o.data[e],n=o.data[e+1],a=o.data[e+2],r=h[b],s=h[b+1],i=h[b+2];Math.abs(t-r)<=3&&Math.abs(a-i)<=3&&Math.abs(n-s)<=3?(u.data[e]=0,u.data[e+1]=0,u.data[e+2]=0,u.data[e+3]=0):(m=!0,h[b]=u.data[e]=t,h[b+1]=u.data[e+1]=n,h[b+2]=u.data[e+2]=a,u.data[e+3]=255),b+=3}if(i++,m){s.putImageData(u,0,0);const e=await new Response((await a.convertToBlob({quality:1,type:"image/webp"})).stream().pipeThrough(new CompressionStream("gzip"))).arrayBuffer();w.unshift([l,e.byteLength]),r.send(e)}}}))}catch(e){console.error("Error: "+e)}},(()=>{const e=document.createElement("canvas");document.body.appendChild(e);const t=e.getContext("2d");if(!t)return;const n=[];let o;r.addEventListener("message",(async({data:a})=>{try{const o=new Image;n.push(o),o.src=URL.createObjectURL(await new Response(a.stream().pipeThrough(new DecompressionStream("gzip"))).blob()),o.onload=()=>{i++,URL.revokeObjectURL(o.src),o.dataset.load="1",(()=>{let o;for(;n[0]?.dataset?.load&&(o=n.shift());){const{height:n,width:a}=o;console.log(n,a),n&&e.height!==n&&(e.height=n),a&&e.width!==a&&(e.width=a),t.drawImage(o,0,0)}})()}}catch(r){const[s,i]=new Uint16Array(await a.arrayBuffer());e.width=s,e.height=i,t.fillStyle="#000",t.fillRect(0,0,s,i),o=t.getImageData(0,0,s,i),n.length=0}}))})()})()})();